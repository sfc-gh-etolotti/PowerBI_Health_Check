


CREATE OR REPLACE DATABASE PBIHealthCheck;
CREATE OR REPLACE  SCHEMA PBIHealthCheck.JobData;
CREATE OR REPLACE WAREHOUSE pbi_healthcheck
    WAREHOUSE_SIZE = 'medium'
    WAREHOUSE_TYPE = 'standard'
    AUTO_SUSPEND = 60
    AUTO_RESUME = TRUE
    INITIALLY_SUSPENDED = TRUE
COMMENT = 'warehouse for power bi health check';

USE DATABASE PBIHealthCheck;
USE SCHEMA JobData;
USE WAREHOUSE pbi_healthcheck;

create or replace TABLE PBIHealthCheck.JobData.POWERBI_CUSTOMER_HEALTH_CHECKS cluster by (WAREHOUSE_NAME)(
	START_TIME TIMESTAMP_LTZ(6),
	END_TIME TIMESTAMP_NTZ(9),
	TOOL VARCHAR(16777216),
	CLIENT_ENVIRONMENT VARIANT,
    CLIENT VARCHAR(16777216),
	CLIENT_APP_ID VARCHAR(16777216),
	SESSION_ID NUMBER(38,0),
	QUERY_ID VARCHAR(16777216),
	SQL_TEXT VARCHAR(16777216),
	EXECUTION_STATUS VARCHAR(16777216),
	TOTAL_ELAPSED_TIME NUMBER(38,0),
	ERROR_CODE VARCHAR(16777216),
	ERROR_MESSAGE VARCHAR(16777216),
	ROLE_NAME VARCHAR(16777216),
	ROWS_PRODUCED NUMBER(38,0),
	USER_NAME VARCHAR(16777216),
	WAREHOUSE_ID NUMBER(38,0),
	WAREHOUSE_NAME VARCHAR(16777216),
	DUR_COMPILING NUMBER(38,0),
	DUR_QUEUED_LOAD NUMBER(38,0),
	DUR_WORKER_GROUP_WAIT NUMBER(38,0),
	DUR_XP_EXECUTING NUMBER(38,0),
	DUR_ABORTING NUMBER(38,0),
	GB_SPILLED_TO_REMOTE_STORAGE FLOAT,
	PARTITIONS_SCANNED NUMBER(38,0),
	PARTITIONS_TOTAL NUMBER(38,0),
	GB_SPILLED_TO_LOCAL_STORAGE FLOAT,
	PARTITION_SCAN_RATIO NUMBER(38,6),
	BYTES_SCANNED NUMBER(38,0),
	PERCENTAGE_SCANNED_FROM_CACHE FLOAT,
	SQL_TEXT_HASH VARCHAR(16777216),
	COMPILATION_RATIO FLOAT,
	STATEMENT_TYPE VARCHAR(16777216),
	TAG VARCHAR(16777216)
);


create or replace TABLE PBIHealthCheck.JobData.POWERBI_CUSTOMER_WH_OVERLAP (
	SESSION_ID NUMBER(38,0),
	WAREHOUSE_NAME VARCHAR(16777216),
	WAREHOUSE_SIZE_SORT NUMBER(38,0),
	QUERIES NUMBER(38,0),
	CLIENT VARCHAR(16777216),
	CLIENT_ENVIRONMENT VARIANT,
	CLIENT_ENV_APP_STRING VARCHAR(16777216),
	CLIENT_APP_ID VARCHAR(16777216),
	TOOL VARCHAR(16777216)
);

create or replace TABLE PBIHealthCheck.JobData.POWERBI_TABLE_ACCESS_HISTORY (
	SESSION_ID NUMBER(38,0),
	QUERY_ID VARCHAR(16777216),
	TABLE_VIEW_NAME VARCHAR(16777216),
	WAREHOUSE_NAME VARCHAR(16777216)
);


create or replace TABLE PBIHealthCheck.JobData.POWERBI_QAS_ELIGIBLE (
	QAS_ELIGIBLE VARCHAR(3),
	SESSION_ID NUMBER(38,0),
	QUERY_ID VARCHAR(16777216)
);